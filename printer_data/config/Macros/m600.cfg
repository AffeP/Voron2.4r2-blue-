;[gcode_macro M600]
;gcode:
;    {% set X = params.X|default(175)|float %}
;    {% set Y = params.Y|default(5)|float %}
;    {% set Z = params.Z|default(20)|float %}
;    {% set TARGET_TEMP = printer.extruder.target|int %}
;    SAVE_GCODE_STATE NAME=M600_state
;    PAUSE
;    SET_FILAMENT_SENSOR SENSOR=RunoutSensor ENABLE=0
;    M117 Change filament
;    ## BEEP_ATTENTION
;    M118 Macro M600
;    G91                         # Relative position, if in middle of print move Z away from print
;    ## G1 E-.8 F2700
;    G1 Z{Z} F3000
;    G90                         # Absolut position, to move nozzle in front
;    G1 X{X} Y{Y} F3000
;    G91     
;    ## G1 E-50 F1000
;    G92 E0
;    UPDATE_DELAYED_GCODE ID=clear_display DURATION=30
;    SET_FILAMENT_SENSOR SENSOR=RunoutSensor ENABLE=1
;    RESTORE_GCODE_STATE NAME=M600_state

[gcode_macro M600]
gcode:
    {% set X = params.X|default(175)|int %}
    {% set Y = params.Y|default(5)|int %}
    {% set Z = params.Z|default(25)|int %}
    {% set E_LOAD = params.E_LOAD|default(50)|int %} ; Amount to purge on load
    {% set E_UNLOAD = params.E_UNLOAD|default(600)|int %} ; Amount to retract on unload
    SET_FILAMENT_SENSOR SENSOR=RunoutSensor ENABLE=0

    ; Store the current extruder temperature target
    {% set TARGET_TEMP = printer.extruder.target|int %}
    
    ; Pause the print, park the toolhead, and set a low standby temperature
    PAUSE_BASE
    G91 ; Relative positioning
    G1 Z{Z} F360 ; Move Z axis up
    G90 ; Absolute positioning
    G1 X{X} Y{Y} F7200 ; Park toolhead
    M104 S210 ; Set extruder temp to 100C for safe unloading

    ; Wait for temperature to drop for safe unload (adjust as needed)
    M109 S210

    ; Unload filament
    G91 ; Relative positioning
    G1 E-5 F120
    G1 E-{E_UNLOAD} F3600
    G90 ; Absolute positioning
    
    M0 ; Wait for user action (manual filament change)
    
    ; *** User changes filament here ***

    ; Heat up for loading and purging
    SET_FILAMENT_SENSOR SENSOR=RunoutSensor ENABLE=1
    M109 S{TARGET_TEMP} ; Heat to the original target temperature

    ; Load and purge new filament
    G91 ; Relative positioning
    G1 E{E_LOAD} F360 ; Purge a bit
    G90 ; Absolute positioning

    ; Resume print using the PAUSE_RESUME macro
    RESUME_BASE

[gcode_macro BEEP_ATTENTION]
gcode:
	{% set V = 0.5 %}
	M300 S440 P200 V{V}
	G4 P200
	M300 S440 P200 V{V}
	G4 P200
	M300 S440 P200 V{V}
	G4 P200
	M300 S440 P200 V{V}
	G4 P200

[gcode_macro M601]
gcode:
    PAUSE
    ## BEEP_ATTENTION

